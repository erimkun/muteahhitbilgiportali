<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dosya YÃ¶netimi - Admin Panel</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      padding: 5px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    .nav-tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      font-weight: 600;
    }
    .nav-tab.active {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .tab-content.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .content-grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 25px;
      height: calc(100vh - 200px);
    }
    .sidebar {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow-y: auto;
    }
    .main-content {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow-y: auto;
    }
    .project-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .project-item {
      padding: 12px 15px;
      margin: 8px 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }
    .project-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }
    .project-item.active {
      background: rgba(102, 126, 234, 0.2);
      border-color: rgba(102, 126, 234, 0.5);
    }
    .file-categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .category-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .category-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }
    .file-count {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .upload-area {
      margin-bottom: 15px;
    }
    .upload-zone {
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: rgba(255, 255, 255, 0.7);
    }
    .upload-zone:hover {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.05);
    }
    .upload-zone.drag-over {
      border-color: #007bff;
      background: rgba(0, 123, 255, 0.1);
    }
    .file-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin: 4px 0;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      font-size: 13px;
    }
    
    /* YENÄ°: Frontend asset kategorileri iÃ§in Ã¶zel stiller */
    .category-card.frontend-asset {
      border-left: 4px solid #3b82f6;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
    }
    
    .category-card.frontend-asset .category-title {
      color: #60a5fa;
    }
    
    .upload-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .upload-result.success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #86efac;
    }
    
    .upload-result.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }
    
    .zip-extraction-info {
      margin-top: 5px;
      padding: 5px 10px;
      background: rgba(168, 85, 247, 0.1);
      border-radius: 4px;
      font-size: 11px;
      color: #c4b5fd;
    }
    
    .file-rename-info {
      margin-top: 3px;
      font-size: 10px;
      color: #94a3b8;
      font-style: italic;
    }
    .file-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-right: 10px;
    }
    .file-actions {
      display: flex;
      gap: 5px;
    }
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-danger {
      background: rgba(239, 68, 68, 0.8);
      color: white;
    }
    .btn-success {
      background: rgba(34, 197, 94, 0.8);
      color: white;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .upload-zone {
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.1);
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }
    select, input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 14px;
    }
    select option {
      background: #1a1a2e;
      color: #fff;
    }
    .user-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      overflow: hidden;
    }
    .user-table th,
    .user-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .user-table th {
      background: rgba(255, 255, 255, 0.1);
      font-weight: 600;
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .status-active {
      background: #4ade80;
      color: #000;
    }
    .status-inactive {
      background: #f87171;
      color: #000;
    }
    .message {
      padding: 12px 16px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 600;
      display: none;
    }
    .message.success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
      color: #22c55e;
    }
    .message.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
      display: none;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      width: 0%;
      transition: width 0.3s ease;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #4ade80;
      margin-bottom: 5px;
    }
    .stat-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
    }
    @media (max-width: 768px) {
      .content-grid {
        grid-template-columns: 1fr;
        height: auto;
      }
      .sidebar {
        order: 2;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>ğŸ—‚ï¸ Dosya YÃ¶netimi - Admin Panel</h1>
        <p id="adminInfo">YÃ¼kleniyor...</p>
      </div>
      <div>
        <button class="btn btn-secondary" id="projectsBtn">ğŸ—ï¸ Projeler</button>
        <button class="btn btn-danger" id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="files">ğŸ“ Dosya YÃ¶netimi</button>
      <button class="nav-tab" data-tab="upload">â¬†ï¸ Dosya YÃ¼kleme</button>
      <button class="nav-tab" data-tab="users">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</button>
      <button class="nav-tab" data-tab="stats">ğŸ“Š Ä°statistikler</button>
    </div>

    <div class="message" id="message"></div>

    <!-- Dosya YÃ¶netimi Tab -->
    <div class="tab-content active" id="files-tab">
      <div class="content-grid">
        <div class="sidebar">
          <h3>ğŸ“‹ Projeler</h3>
          <ul class="project-list" id="projectList">
            <li class="project-item">Projeler yÃ¼kleniyor...</li>
          </ul>
        </div>
        <div class="main-content">
          <div id="filesContent">
            <p style="text-align: center; color: rgba(255,255,255,0.6); padding: 40px;">
              ğŸ‘ˆ Soldan bir proje seÃ§in
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Dosya YÃ¼kleme Tab -->
    <div class="tab-content" id="upload-tab">
      <div class="form-group">
        <label for="uploadProject">Proje SeÃ§in</label>
        <select id="uploadProject">
          <option value="">Proje seÃ§in...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="uploadCategory">Dosya Kategorisi</label>
        <select id="uploadCategory">
          <option value="drone_photos">ğŸš Drone FotoÄŸraflarÄ± (GÃ¶rseller)</option>
          <option value="drone_photos_file">ğŸš Drone FotoÄŸraflarÄ± (ArÅŸiv)</option>
          <option value="floor_plans">ğŸ“ Kat PlanlarÄ± (GÃ¶rseller)</option>
          <option value="floor_plans_file">ğŸ“ Kat PlanlarÄ± (DWG/ZIP)</option>
          <option value="orthophoto">ğŸ—ºï¸ Ortofoto</option>
          <option value="view_360">ğŸŒ 360Â° GÃ¶rÃ¼nÃ¼m</option>
          <option value="fbx_model_file">ğŸ—ï¸ 3D Model (FBX ZIP)</option>
          <option value="muteahhit">ğŸ—ï¸ MÃ¼teahhit Deposu (Serbest)</option>
          <option value="other">ğŸ“‹ DiÄŸer Belgeler</option>
        </select>
      </div>

      <div class="upload-zone" id="uploadZone">
        <p>ğŸ“ DosyalarÄ± buraya sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n</p>
        <p style="font-size: 12px; opacity: 0.7;">JPG, PNG, PDF, DWG, ZIP, RAR, FBX desteklenir</p>
        <input type="file" id="fileInput" multiple accept="image/*,.pdf,.dwg,.zip,.rar,.fbx" style="display: none;">
      </div>

      <div id="selectedFiles" style="margin: 20px 0;"></div>
      <div class="progress-bar" id="uploadProgress">
        <div class="progress-fill" id="uploadProgressFill"></div>
      </div>
      
      <button class="btn btn-primary" id="uploadBtn" disabled>
        ğŸ“¤ DosyalarÄ± YÃ¼kle
      </button>
    </div>

    <!-- KullanÄ±cÄ± YÃ¶netimi Tab -->
    <div class="tab-content" id="users-tab">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>ğŸ‘¥ KullanÄ±cÄ± Listesi</h3>
        <button class="btn btn-primary" id="addUserBtn">â• Yeni KullanÄ±cÄ±</button>
      </div>
      
      <table class="user-table" id="userTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Telefon</th>
            <th>Rol</th>
            <th>Durum</th>
            <th>Atanan Projeler</th>
            <th>Ä°ÅŸlemler</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <tr><td colspan="6" style="text-align: center;">KullanÄ±cÄ±lar yÃ¼kleniyor...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Ä°statistikler Tab -->
    <div class="tab-content" id="stats-tab">
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-value" id="totalProjects">-</div>
          <div class="stat-label">Toplam Proje</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalFiles">-</div>
          <div class="stat-label">Toplam Dosya</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">-</div>
          <div class="stat-label">Toplam KullanÄ±cÄ±</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalSize">-</div>
          <div class="stat-label">Toplam Boyut</div>
        </div>
      </div>
      
      <h3>ğŸ“ˆ Proje BazÄ±nda Dosya DaÄŸÄ±lÄ±mÄ±</h3>
      <div id="projectStats"></div>
    </div>
  </div>

  <script>
    let selectedProject = null;
    let projects = [];
    let users = [];
    
    // Global fileExtensions tanÄ±mÄ±
    const fileExtensions = {
      // Backend kategorileri (mevcut)
      drone_photos_jpg: ['.jpg', '.jpeg'],
      drone_photos_zip: ['.zip', '.rar'],
      floor_plans_jpeg: ['.jpg', '.jpeg', '.png'],
      floor_plans_dwg: ['.dwg', '.dxf'],
      orthophoto_jpeg: ['.jpg', '.jpeg'],
      orthophoto_tiff: ['.tiff', '.tif'],
      view_360: ['.jpg', '.jpeg', '.png'],
      models_fbx: ['.zip', '.rar'],
      documents_pdf: ['.pdf', '.doc', '.docx'],
      files_zip: ['.zip', '.rar', '.7z'],
      other: [],
      contractor_depot: null,
      
      // YENÄ°: Frontend kategorileri
      frontend_models: ['.gltf', '.glb', '.bin'],
      frontend_tiles: ['.json', '.bin', '.b3dm', '.i3dm', '.pnts', '.cmpt'],
      frontend_360views: ['.jpg', '.jpeg', '.png'],
      frontend_tiles_zip: ['.zip', '.rar', '.7z']
    };
    
    // Sayfa yÃ¼klendiÄŸinde
    document.addEventListener('DOMContentLoaded', function() {
      loadAdminInfo();
      loadProjects();
      loadUsers();
      loadStats();
      setupFileUpload();
    });

    async function loadAdminInfo() {
      try {
        const response = await fetch('/session', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          if (data.admin) {
            document.getElementById('adminInfo').textContent = 
              `Admin: ${data.admin.phone} (${data.admin.role})`;
          }
        }
      } catch (error) {
        console.error('Admin bilgileri yÃ¼klenemedi:', error);
      }
    }

    async function loadProjects() {
      try {
        const response = await fetch('/api/projects', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          projects = data.data;
          renderProjectList();
          updateUploadProjectSelect();
        }
      } catch (error) {
        showMessage('Projeler yÃ¼klenirken hata oluÅŸtu', 'error');
      }
    }

    function renderProjectList() {
      const list = document.getElementById('projectList');
      list.innerHTML = '';
      
      projects.forEach(project => {
        const item = document.createElement('li');
        item.className = 'project-item';
        item.innerHTML = `
          <div style="font-weight: 600;">${project.project_code}</div>
          <div style="font-size: 12px; opacity: 0.8;">${project.name}</div>
          <div style="font-size: 11px; opacity: 0.6; margin-top: 4px;">
            <span class="status-badge ${project.is_active ? 'status-active' : 'status-inactive'}">
              ${project.is_active ? 'Aktif' : 'Pasif'}
            </span>
          </div>
        `;
        item.dataset.projectId = project.id;
        list.appendChild(item);
      });
    }

    function updateUploadProjectSelect() {
      const select = document.getElementById('uploadProject');
      select.innerHTML = '<option value="">Proje seÃ§in...</option>';
      
      projects.forEach(project => {
        if (project.is_active) {
          const option = document.createElement('option');
          option.value = project.project_code;
          option.textContent = `${project.project_code} - ${project.name}`;
          select.appendChild(option);
        }
      });
    }

    async function selectProject(projectId) {
      const project = projects.find(p => p.id === projectId);
      if (!project) return;
      
      selectedProject = project;
      
      // Aktif proje gÃ¶rselini gÃ¼ncelle
      document.querySelectorAll('.project-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // TÄ±klanan projeyi aktif yap
      const clickedItem = document.querySelector(`[data-project-id="${projectId}"]`);
      if (clickedItem) {
        clickedItem.classList.add('active');
      }
      
      // Proje dosyalarÄ±nÄ± yÃ¼kle
      await loadProjectFiles(project.id);
    }

    async function loadProjectFiles(projectId) {
      const categories = [
        'drone_photos_jpg', 'drone_photos_zip', 'floor_plans_jpeg', 'floor_plans_dwg', 
        'orthophoto_jpeg', 'orthophoto_tiff', 'view_360', 'models_fbx', 
        'documents_pdf', 'files_zip', 'other', 'contractor_depot',
        // YENÄ°: Frontend asset kategorileri
        'frontend_models', 'frontend_tiles', 'frontend_360views', 'frontend_tiles_zip'
      ];
      const categoryNames = {
        // Backend kategorileri (mevcut)
        drone_photos_jpg: 'ğŸš Drone FotoÄŸraflarÄ± (JPEG)',
        drone_photos_zip: 'ğŸš Drone FotoÄŸraflarÄ± (ZIP)',
        floor_plans_jpeg: 'ğŸ“ Kat PlanlarÄ± (JPEG)',
        floor_plans_dwg: 'ğŸ“ Kat PlanlarÄ± (DWG)',
        orthophoto_jpeg: 'ğŸ—ºï¸ Ortofoto (JPEG)',
        orthophoto_tiff: 'ğŸ—ºï¸ Ortofoto (TIFF)',
        view_360: 'ğŸ“· 360Â° GÃ¶rÃ¼ntÃ¼ler',
        models_fbx: 'ğŸ—ï¸ 3D Modeller (FBX)',
        documents_pdf: 'ğŸ“„ Belgeler (PDF)',
        files_zip: 'ğŸ“¦ ArÅŸiv DosyalarÄ± (ZIP)',
        other: 'ğŸ“ DiÄŸer',
        contractor_depot: 'ğŸ—ï¸ MÃ¼teahhit Deposu (Serbest)',
        
        // YENÄ°: Frontend kategorileri
        frontend_models: 'ğŸ­ 3D Modeller (Frontend)',
        frontend_tiles: 'ğŸ­ Tileset DosyalarÄ± (Frontend)', 
        frontend_360views: 'ğŸ­ 360Â° GÃ¶rÃ¼ntÃ¼ler (Frontend)',
        frontend_tiles_zip: 'ğŸ­ Tileset ZIP KlasÃ¶rÃ¼'
      };
      // Removed old categories
      const categoryNames_old_removed = {
        floor_plans_old: 'ï¿½ GÃ¶rÃ¼ntÃ¼ler',
        orthophoto: 'ï¿½ Belgeler'
      };

      
      // YENÄ°: Kategori aÃ§Ä±klamalarÄ±
      const categoryDescriptions = {
        frontend_models: 'Cesium iÃ§in GLTF/GLB modeller - Otomatik olarak bina_model.gltf olarak adlandÄ±rÄ±lÄ±r',
        frontend_tiles: 'Cesium tileset dosyalarÄ± - JSON dosyasÄ± otomatik olarak sezyum_{projeKodu}.json olur',
        frontend_360views: 'Panoramik gÃ¶rÃ¼ntÃ¼ler - Otomatik olarak panorama_{projeKodu}.jpg formatÄ±nda adlandÄ±rÄ±lÄ±r',
        frontend_tiles_zip: 'Tileset ZIP klasÃ¶rÃ¼ - KlasÃ¶r yapÄ±sÄ± korunarak Ã§Ä±karÄ±lÄ±r ve ana JSON yeniden adlandÄ±rÄ±lÄ±r'
      };

      const content = document.getElementById('filesContent');
      content.innerHTML = `
        <h3>ğŸ“ ${selectedProject.name} DosyalarÄ±</h3>
        <div class="category-card" style="margin-top: 10px; margin-bottom: 20px;">
          <div class="category-header">
            <div class="category-title">ğŸ¥ Drone Videosu (YouTube URL)</div>
            <div>
              <button class="btn btn-success" id="saveYoutubeUrlBtn">Kaydet</button>
            </div>
          </div>
          <div class="form-group" style="margin: 0;">
            <input type="text" id="youtubeUrlInput" placeholder="https://www.youtube.com/watch?v=... veya https://youtu.be/..." />
            <small style="display:block; opacity:0.7; margin-top:6px;">Bu baÄŸlantÄ± frontend'de Drone Videosu kartÄ±nda gÃ¶sterilir.</small>
          </div>
          <div id="youtubeSaveMsg" class="message" style="display:none; margin-top:10px;"></div>
        </div>
        <div class="file-categories" id="fileCategories">
          ${categories.map(cat => `
            <div class="category-card ${cat.startsWith('frontend_') ? 'frontend-asset' : ''}">
              <div class="category-header">
                <div class="category-title">${categoryNames[cat] || cat}</div>
                <div class="file-count" id="count-${cat}">0</div>
              </div>
              <div class="upload-area" id="upload-${cat}">
                <input type="file" id="file-input-${cat}" multiple style="display: none;" data-category="${cat}" 
                       accept="${fileExtensions[cat] && fileExtensions[cat].length > 0 ? fileExtensions[cat].join(',') : '*'}">
                <div class="upload-zone" data-category="${cat}" data-input="file-input-${cat}">
                  <span>ğŸ“ Dosya YÃ¼kle veya SÃ¼rÃ¼kle</span>
                  <small style="display: block; margin-top: 5px; opacity: 0.7;">
                    ${fileExtensions[cat] && fileExtensions[cat].length > 0 ? 
                      `Ä°zin verilen: ${fileExtensions[cat].join(', ')}` : 
                      'TÃ¼m dosya tÃ¼rleri'
                    }
                  </small>
                  ${categoryDescriptions[cat] ? 
                    `<small style="display: block; margin-top: 3px; opacity: 0.6; font-style: italic;">
                      â„¹ï¸ ${categoryDescriptions[cat]}
                    </small>` : ''
                  }
                </div>
              </div>
              <div class="file-list" id="files-${cat}">
                <div style="text-align: center; padding: 20px; opacity: 0.6;">YÃ¼kleniyor...</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // TÃ¼m dosyalarÄ± tek API Ã§aÄŸrÄ±sÄ±yla yÃ¼kle
      try {
        const response = await fetch(`/admin/projects/${projectId}/files`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const result = await response.json();
          const filesData = result.data?.files || result.files || result;
          
          console.log('Files API Response:', result);
          console.log('Files Data:', filesData);
          
          // selectedProject'i set et - API response'unda proje bilgisi var
          if (result.data?.project) {
            selectedProject = result.data.project;
            console.log('Selected project set to:', selectedProject);
          }
          
          // Her kategori iÃ§in dosyalarÄ± render et
          categories.forEach(category => {
            renderCategoryFiles(category, filesData[category] || []);
          });
        } else {
          console.error('Error loading project files:', response.status);
          // Hata durumunda kategorileri temizle
          categories.forEach(category => renderCategoryFiles(category, []));
        }
      } catch (error) {
        console.error('Error loading project files:', error);
        // Hata durumunda kategorileri temizle
        categories.forEach(category => renderCategoryFiles(category, []));
      }
      
      // Load and render current YouTube URL
      let currentAssets = {};
      try {
        const assetsResp = await fetch(`/api/projects/${projectId}/assets`, { credentials: 'include' });
        if (assetsResp.ok) {
          const assetsData = await assetsResp.json();
          currentAssets = assetsData.data || {};
          const ytInput = document.getElementById('youtubeUrlInput');
          if (ytInput) ytInput.value = currentAssets.drone_video_url || '';
        }
      } catch (e) {
        console.warn('Failed to load project assets:', e);
      }

      // Save YouTube URL handler
      const saveBtn = document.getElementById('saveYoutubeUrlBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
          const input = document.getElementById('youtubeUrlInput');
          const msg = document.getElementById('youtubeSaveMsg');
          const newUrl = input.value.trim();
          try {
            const payload = {
              fbx_zip_url: currentAssets.fbx_zip_url || null,
              drone_photos_gallery_url: currentAssets.drone_photos_gallery_url || null,
              drone_photos_zip_url: currentAssets.drone_photos_zip_url || null,
              drone_video_url: newUrl || null,
              view_360_url: currentAssets.view_360_url || null,
              orthophoto_url: currentAssets.orthophoto_url || null,
              floor_plans_gallery_url: currentAssets.floor_plans_gallery_url || null,
              floor_plans_autocad_url: currentAssets.floor_plans_autocad_url || null
            };
            const resp = await fetch(`/api/projects/${projectId}/assets`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            if (resp.ok) {
              msg.textContent = 'YouTube URL kaydedildi';
              msg.className = 'message success';
              msg.style.display = 'block';
              setTimeout(() => msg.style.display = 'none', 3000);
              currentAssets.drone_video_url = newUrl;
            } else {
              const err = await resp.json().catch(() => ({}));
              msg.textContent = err.error || 'Kaydetme hatasÄ±';
              msg.className = 'message error';
              msg.style.display = 'block';
              setTimeout(() => msg.style.display = 'none', 4000);
            }
          } catch (e) {
            const msg = document.getElementById('youtubeSaveMsg');
            msg.textContent = 'BaÄŸlantÄ± hatasÄ±';
            msg.className = 'message error';
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 4000);
          }
        });
      }

      // Setup event listeners after DOM is updated
      setupFileEventListeners();
    }

    function renderCategoryFiles(category, files) {
      const container = document.getElementById(`files-${category}`);
      const counter = document.getElementById(`count-${category}`);
      
      if (!container || !counter) {
        console.warn(`Elements not found for category: ${category}`);
        return;
      }
      
      counter.textContent = files.length;
      
      if (files.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.6;">Dosya yok</div>';
        return;
      }

      container.innerHTML = files.map(file => {
        // Dosya boyutunu formatla
        const formatFileSize = (bytes) => {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        // Dosya ikonu belirle
        const getFileIcon = (fileName) => {
          const ext = fileName.split('.').pop().toLowerCase();
          if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'ğŸ–¼ï¸';
          if (['pdf'].includes(ext)) return 'ğŸ“„';
          if (['doc', 'docx'].includes(ext)) return 'ğŸ“';
          if (['xls', 'xlsx'].includes(ext)) return 'ğŸ“Š';
          if (['zip', 'rar'].includes(ext)) return 'ğŸ“¦';
          if (['obj', 'fbx', 'dae', 'gltf', 'glb'].includes(ext)) return 'ğŸ—ï¸';
          return 'ğŸ“';
        };

        return `
          <div class="file-item">
            <div class="file-name" title="${file.name}">
              ${getFileIcon(file.name)} ${file.name.length > 30 ? file.name.substring(0, 30) + '...' : file.name}
            </div>
            <div class="file-info">
              <small>${formatFileSize(file.size || 0)}</small>
            </div>
            <div class="file-actions">
              <button class="btn btn-secondary download-btn" data-file-path="${file.path}" title="Ä°ndir">
                â¬‡ï¸
              </button>
              <button class="btn btn-secondary rename-btn" data-file-path="${file.path}" data-category="${category}" data-filename="${file.name}" title="Yeniden AdlandÄ±r">
                âœï¸
              </button>
              <button class="btn btn-danger delete-btn" data-file-path="${file.path}" data-category="${category}" data-filename="${file.name}" title="Sil">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function setupFileEventListeners() {
      // Upload zone click handlers
      document.querySelectorAll('.upload-zone').forEach(zone => {
        zone.addEventListener('click', function() {
          const inputId = this.getAttribute('data-input');
          document.getElementById(inputId).click();
        });
        
        // Drag and drop handlers
        zone.addEventListener('dragover', function(e) {
          e.preventDefault();
          this.classList.add('drag-over');
        });
        
        zone.addEventListener('dragleave', function(e) {
          e.preventDefault();
          this.classList.remove('drag-over');
        });
        
        zone.addEventListener('drop', function(e) {
          e.preventDefault();
          this.classList.remove('drag-over');
          const category = this.getAttribute('data-category');
          const files = e.dataTransfer.files;
          handleFileUpload(category, files);
        });
      });
      
      // File input change handlers
      document.querySelectorAll('input[type="file"][data-category]').forEach(input => {
        input.addEventListener('change', function() {
          const category = this.getAttribute('data-category');
          handleFileUpload(category, this.files);
        });
      });
      
      // Download button handlers
      document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const filePath = this.getAttribute('data-file-path');
          downloadFile(filePath);
        });
      });
      
      // Delete button handlers
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          console.log('Delete button clicked, selectedProject:', selectedProject);
          if (!selectedProject || !selectedProject.id) {
            showMessage('Proje seÃ§ilmemiÅŸ', 'error');
            return;
          }
          const filePath = this.getAttribute('data-file-path');
          console.log('Deleting file:', filePath, 'for project:', selectedProject.id);
          deleteFile(selectedProject.id, filePath);
        });
      });

      // Rename button handlers
      document.querySelectorAll('.rename-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          if (!selectedProject || !selectedProject.id) {
            showMessage('Proje seÃ§ilmemiÅŸ', 'error');
            return;
          }
          const oldName = this.getAttribute('data-filename');
          const filePath = this.getAttribute('data-file-path');
          const newName = prompt('Yeni dosya adÄ±nÄ± girin', oldName);
          if (!newName || newName.trim() === '' || newName === oldName) return;
          await renameFile(selectedProject.id, { filePath, oldName, newName: newName.trim() });
        });
      });
    }

    function downloadFile(url) {
      const cleaned = url.replace(/^\/*/, '');
      // Use current host for download URLs instead of hardcoded localhost
      const fullUrl = url.startsWith('http') ? url : `${window.location.protocol}//${window.location.host}/upload/${cleaned}`;
      window.open(fullUrl, '_blank');
    }

    async function deleteFile(projectId, filePath) {
      if (!confirm('Bu dosyayÄ± silmek istediÄŸinizden emin misiniz?')) return;
      
      try {
        const response = await fetch(`/admin/projects/${projectId}/files`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ filePath }),
          credentials: 'include'
        });
        
        if (response.ok) {
          showMessage('Dosya baÅŸarÄ±yla silindi', 'success');
          loadProjectFiles(projectId);
        } else {
          const result = await response.json();
          showMessage(result.error || 'Dosya silinirken hata oluÅŸtu', 'error');
        }
      } catch (error) {
        showMessage('BaÄŸlantÄ± hatasÄ±', 'error');
      }
    }

    async function renameFile(projectId, payload) {
      try {
        const response = await fetch(`/admin/projects/${projectId}/files/rename`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          credentials: 'include'
        });
        if (response.ok) {
          showMessage('Dosya adÄ± gÃ¼ncellendi', 'success');
          await loadProjectFiles(projectId);
        } else {
          const result = await response.json().catch(() => ({}));
          showMessage(result.error || 'Yeniden adlandÄ±rma baÅŸarÄ±sÄ±z', 'error');
        }
      } catch (e) {
        showMessage('BaÄŸlantÄ± hatasÄ±', 'error');
      }
    }

    // YENÄ°: GeliÅŸmiÅŸ dosya upload fonksiyonu
    async function handleFileUpload(category, files) {
      if (!files || files.length === 0) return;
      
      if (!selectedProject || !selectedProject.id) {
        showMessage('Proje seÃ§ilmemiÅŸ', 'error');
        return;
      }
      
      // Dosya uzantÄ±sÄ± kontrolÃ¼
      if (category !== 'other' && category !== 'contractor_depot' && fileExtensions[category]) {
        for (let file of files) {
          const fileExt = '.' + file.name.split('.').pop().toLowerCase();
          if (!fileExtensions[category].includes(fileExt)) {
            showMessage(`Dosya ${file.name} bu kategori iÃ§in uygun deÄŸil. Ä°zin verilen: ${fileExtensions[category].join(', ')}`, 'error');
            return;
          }
        }
      }
      
      // Upload alanÄ±na progress gÃ¶stergesi ekle
      const uploadArea = document.getElementById(`upload-${category}`);
      const originalContent = uploadArea.innerHTML;
      
      uploadArea.innerHTML = `
        <div class="upload-progress">
          <div>ğŸ“¤ YÃ¼kleniyor...</div>
          <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 10px;">
            <div id="progress-${category}" style="height: 100%; background: #3b82f6; border-radius: 2px; width: 0%; transition: width 0.3s;"></div>
          </div>
        </div>
      `;
      
      const formData = new FormData();
      for (let file of files) {
        formData.append('files', file);
      }
      formData.append('category', category);
      formData.append('projectId', selectedProject.id);
      
      try {
        const xhr = new XMLHttpRequest();
        
        // Progress tracking
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            const progressBar = document.getElementById(`progress-${category}`);
            if (progressBar) {
              progressBar.style.width = percentComplete + '%';
            }
          }
        });
        
        xhr.onreadystatechange = async function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            // Restore original upload area
            uploadArea.innerHTML = originalContent;
            
            // Re-attach event listeners
            setupCategoryEventListeners(category);
            
            if (xhr.status === 200) {
              try {
                const result = JSON.parse(xhr.responseText);
                
                // BaÅŸarÄ± mesajÄ±nÄ± oluÅŸtur
                let message = `âœ… ${files.length} dosya baÅŸarÄ±yla yÃ¼klendi`;
                
                // Ã–zel iÅŸlemler hakkÄ±nda bilgi ver
                if (result.data && result.data.files) {
                  const processedFiles = result.data.files;
                  const extractedFiles = processedFiles.filter(f => f.extracted);
                  const renamedFiles = processedFiles.filter(f => f.renamed);
                  
                  if (extractedFiles.length > 0) {
                    message += `\nğŸ“¦ ${extractedFiles.length} ZIP dosyasÄ± Ã§Ä±karÄ±ldÄ±`;
                  }
                  
                  if (renamedFiles.length > 0) {
                    message += `\nğŸ·ï¸ ${renamedFiles.length} dosya yeniden adlandÄ±rÄ±ldÄ±`;
                  }
                }
                
                showMessage(message, 'success');
                
                // Upload sonuÃ§larÄ±nÄ± gÃ¶ster
                displayUploadResults(category, result.data);
                
                // Dosya listesini yenile
                await loadProjectFiles(selectedProject.id);
                
              } catch (e) {
                showMessage('Upload baÅŸarÄ±lÄ± ama sonuÃ§ parse edilemedi', 'warning');
                await loadProjectFiles(selectedProject.id);
              }
              
            } else {
              let errorMsg = 'Dosya yÃ¼kleme hatasÄ±';
              try {
                const result = JSON.parse(xhr.responseText);
                errorMsg = result.error || errorMsg;
              } catch (e) {
                errorMsg += ' (HTTP ' + xhr.status + ')';
              }
              showMessage(errorMsg, 'error');
            }
          }
        };
        
        xhr.open('POST', `/api/projects/${selectedProject.id}/gallery/${category}`);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
        
      } catch (error) {
        // Restore original upload area on error
        uploadArea.innerHTML = originalContent;
        setupCategoryEventListeners(category);
        showMessage('BaÄŸlantÄ± hatasÄ±: ' + error.message, 'error');
      }
    }

    // Upload sonuÃ§larÄ±nÄ± gÃ¶ster
    function displayUploadResults(category, uploadData) {
      if (!uploadData || !uploadData.files) return;
      
      const uploadArea = document.getElementById(`upload-${category}`);
      let resultsHTML = '<div class="upload-results" style="margin-top: 10px;">';
      
      uploadData.files.forEach(file => {
        resultsHTML += `<div class="upload-result-item" style="margin: 5px 0; font-size: 11px; opacity: 0.8;">`;
        resultsHTML += `ğŸ“„ ${file.originalName || file.name}`;
        
        if (file.renamed) {
          resultsHTML += ` â†’ ${file.name}`;
        }
        
        if (file.extracted) {
          resultsHTML += `<br>ğŸ“¦ ZIP Ã§Ä±karÄ±ldÄ±: ${file.extractedFiles} dosya`;
        }
        
        resultsHTML += `</div>`;
      });
      
      resultsHTML += '</div>';
      
      // SonuÃ§larÄ± 10 saniye gÃ¶ster
      uploadArea.innerHTML += resultsHTML;
      setTimeout(() => {
        const results = uploadArea.querySelector('.upload-results');
        if (results) results.remove();
      }, 10000);
    }
    
    // Kategori event listener'larÄ±nÄ± yeniden baÄŸla
    function setupCategoryEventListeners(category) {
      const zone = document.querySelector(`[data-category="${category}"]`);
      const inputId = zone?.getAttribute('data-input');
      const input = document.getElementById(inputId);
      
      if (zone && input) {
        // Click handler
        zone.onclick = () => input.click();
        
        // Drag and drop handlers
        zone.addEventListener('dragover', function(e) {
          e.preventDefault();
          this.classList.add('drag-over');
        });
        
        zone.addEventListener('dragleave', function(e) {
          e.preventDefault();
          this.classList.remove('drag-over');
        });
        
        zone.addEventListener('drop', function(e) {
          e.preventDefault();
          this.classList.remove('drag-over');
          const category = this.getAttribute('data-category');
          const files = e.dataTransfer.files;
          handleFileUpload(category, files);
        });
        
        // File input change
        input.onchange = function() {
          const category = this.getAttribute('data-category');
          handleFileUpload(category, this.files);
        };
      }
    }



    // Tab deÄŸiÅŸtirme
    function switchTab(tabName) {
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
      
      if (tabName === 'stats') {
        loadStats();
      } else if (tabName === 'users') {
        loadUsers();
      }
    }

    // Dosya yÃ¼kleme sistemi
    function setupFileUpload() {
      const uploadZone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('fileInput');
      
      uploadZone.onclick = () => fileInput.click();
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => uploadZone.classList.add('dragover'), false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('dragover'), false);
      });
      
      uploadZone.addEventListener('drop', function(e) {
        fileInput.files = e.dataTransfer.files;
        updateSelectedFiles();
      });
      
      fileInput.addEventListener('change', updateSelectedFiles);
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
    }

    function updateSelectedFiles() {
      const files = document.getElementById('fileInput').files;
      const container = document.getElementById('selectedFiles');
      const uploadBtn = document.getElementById('uploadBtn');
      
      if (files.length === 0) {
        container.innerHTML = '';
        uploadBtn.disabled = true;
        return;
      }
      
      container.innerHTML = `
        <h4>SeÃ§ilen Dosyalar (${files.length})</h4>
        ${Array.from(files).map(file => `
          <div class="file-item">
            <div class="file-name">ğŸ“„ ${file.name}</div>
            <div style="font-size: 11px; opacity: 0.7;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
          </div>
        `).join('')}
      `;
      
      uploadBtn.disabled = false;
    }

    async function uploadFiles() {
      const project = document.getElementById('uploadProject').value;
      const category = document.getElementById('uploadCategory').value;
      const files = document.getElementById('fileInput').files;
      
      if (!project) {
        showMessage('LÃ¼tfen bir proje seÃ§in', 'error');
        return;
      }
      
      if (files.length === 0) {
        showMessage('LÃ¼tfen dosya seÃ§in', 'error');
        return;
      }
      
      const formData = new FormData();
      Array.from(files).forEach(file => {
        formData.append('files', file);
      });
      
      const uploadBtn = document.getElementById('uploadBtn');
      const progressBar = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('uploadProgressFill');
      
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = 'ğŸ“¤ YÃ¼kleniyor...';
      progressBar.style.display = 'block';
      
      try {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressFill.style.width = percentComplete + '%';
          }
        });
        
        xhr.onreadystatechange = function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = 'ğŸ“¤ DosyalarÄ± YÃ¼kle';
            progressBar.style.display = 'none';
            progressFill.style.width = '0%';
            
            if (xhr.status === 200) {
              showMessage('Dosyalar baÅŸarÄ±yla yÃ¼klendi!', 'success');
              document.getElementById('fileInput').value = '';
              updateSelectedFiles();
              
              // EÄŸer seÃ§ili proje aynÄ±ysa dosyalarÄ± yenile
              if (selectedProject && selectedProject.id === parseInt(project)) {
                loadProjectFiles(selectedProject.id);
              }
            } else {
              const error = JSON.parse(xhr.responseText);
              showMessage('YÃ¼kleme hatasÄ±: ' + (error.error || 'Bilinmeyen hata'), 'error');
            }
          }
        };
        
        xhr.open('POST', `/api/projects/${project}/gallery/${category}`);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
        
      } catch (error) {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = 'ğŸ“¤ DosyalarÄ± YÃ¼kle';
        progressBar.style.display = 'none';
        showMessage('YÃ¼kleme hatasÄ±: ' + error.message, 'error');
      }
    }

    async function loadUsers() {
      // Bu fonksiyon user API'si tamamlandÄ±ÄŸÄ±nda implementlenir
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">KullanÄ±cÄ± yÃ¶netimi API\'si hazÄ±rlanÄ±yor...</td></tr>';
    }

    async function loadStats() {
      try {
        // Proje sayÄ±sÄ±
        document.getElementById('totalProjects').textContent = projects.length;
        
        // DiÄŸer istatistikler iÃ§in API Ã§aÄŸrÄ±larÄ± eklenecek
        document.getElementById('totalFiles').textContent = '-';
        document.getElementById('totalUsers').textContent = '-';
        document.getElementById('totalSize').textContent = '-';
        
      } catch (error) {
        console.error('Ä°statistikler yÃ¼klenirken hata:', error);
      }
    }

    function showMessage(text, type) {
      const message = document.getElementById('message');
      message.textContent = text;
      message.className = 'message ' + type;
      message.style.display = 'block';
      setTimeout(() => message.style.display = 'none', 5000);
    }

    function logout() {
      fetch('/logout', { method: 'POST', credentials: 'include' })
        .then(() => window.location.href = '/admin/login')
        .catch(() => alert('Ã‡Ä±kÄ±ÅŸ yaparken hata oluÅŸtu'));
    }

    // User management functions
    async function showAddUserForm() {
      // Load available projects for assignment
      let projects = [];
      try {
        const projResponse = await fetch('/admin/projects', { credentials: 'include' });
        if (projResponse.ok) {
          const projData = await projResponse.json();
          projects = projData.data || [];
        }
      } catch (error) {
        console.error('Failed to load projects:', error);
      }

      // Create modal for adding new user with dark theme
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
        z-index: 1000; backdrop-filter: blur(2px);
      `;
      
      const projectOptions = projects.map(proj => 
        `<option value="${proj.id}">${proj.project_name || proj.name || `Proje ${proj.id}`}</option>`
      ).join('');
      
      modal.innerHTML = `
        <div style="
          background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #2563eb 100%); 
          padding: 30px; border-radius: 15px; width: 500px; max-width: 95%;
          box-shadow: 0 25px 50px rgba(0,0,0,0.5);
          border: 1px solid rgba(255,255,255,0.1);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="color: white; margin: 0; font-size: 24px; font-weight: 600;">ğŸ‘¤ Yeni KullanÄ±cÄ± Ekle</h3>
            <button type="button" class="modal-close-btn" style="
              background: rgba(255,255,255,0.1); border: none; color: white; 
              width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
              font-size: 18px; display: flex; align-items: center; justify-content: center;
            ">Ã—</button>
          </div>
          
          <form id="addUserForm">
            <div style="margin-bottom: 20px;">
              <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">ğŸ“± Telefon NumarasÄ±:</label>
              <input type="text" name="phone" required placeholder="5XXXXXXXXX" style="
                width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
              ">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">ğŸ” Åifre:</label>
              <input type="password" name="password" required placeholder="En az 6 karakter" style="
                width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
              ">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">ğŸ‘¨â€ğŸ’¼ KullanÄ±cÄ± AdÄ±:</label>
              <input type="text" name="name" placeholder="Ä°sim Soyisim" style="
                width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
              ">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">ğŸ—ï¸ Atanacak Proje:</label>
              <select name="project_id" style="
                width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
              ">
                <option value="">Proje SeÃ§iniz (Ä°steÄŸe BaÄŸlÄ±)</option>
                ${projectOptions}
              </select>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">âš¡ Rol:</label>
              <select name="role" style="
                width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
              ">
                <option value="user">ğŸ‘¤ KullanÄ±cÄ±</option>
                <option value="admin">ğŸ‘‘ Admin</option>
              </select>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">ğŸ”„ Durum:</label>
              <select name="is_active" style="
                width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
              ">
                <option value="true">âœ… Aktif</option>
                <option value="false">âŒ Pasif</option>
              </select>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
              <button type="button" class="modal-cancel-btn" style="
                padding: 12px 24px; background: rgba(255,255,255,0.1); color: white; 
                border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer;
                font-size: 16px; transition: all 0.3s ease;
              ">âŒ Ä°ptal</button>
              <button type="submit" style="
                padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white; border: none; border-radius: 8px; cursor: pointer;
                font-size: 16px; font-weight: 600; transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
              ">âœ… KullanÄ±cÄ± Ekle</button>
            </div>
          </form>
        </div>
      `;
      
      modal.className = 'modal';
      document.body.appendChild(modal);
      
      // Handle close buttons
      modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.remove());
      modal.querySelector('.modal-cancel-btn').addEventListener('click', () => modal.remove());
      
      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      // Handle form submission with all fields
      modal.querySelector('#addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'â³ Ekleniyor...';
        submitBtn.disabled = true;
        
        try {
          const userData = {
            phone: formData.get('phone'),
            password: formData.get('password'),
            name: formData.get('name'),
            project_id: formData.get('project_id') || null,
            role: formData.get('role'),
            is_active: formData.get('is_active') === 'true'
          };
          
          const response = await fetch('/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(userData)
          });
          
          if (response.ok) {
            showMessage('âœ… KullanÄ±cÄ± baÅŸarÄ±yla eklendi', 'success');
            modal.remove();
            loadUsers(); // Refresh user list
          } else {
            const errorData = await response.json();
            showMessage('âŒ ' + (errorData.error || 'KullanÄ±cÄ± eklenirken hata oluÅŸtu'), 'error');
          }
        } catch (error) {
          console.error('User creation error:', error);
          showMessage('âŒ BaÄŸlantÄ± hatasÄ±: ' + error.message, 'error');
        } finally {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      });
    }

    async function loadUsers() {
      try {
        const response = await fetch('/admin/users', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          const users = data.data;
          
          // Load project assignments for each user
          const usersWithProjects = await Promise.all(
            users.map(async (user) => {
              try {
                const projResponse = await fetch(`/admin/users/${user.id}/projects`, { credentials: 'include' });
                if (projResponse.ok) {
                  const projData = await projResponse.json();
                  user.assignedProjects = projData.data || [];
                } else {
                  user.assignedProjects = [];
                }
                return user;
              } catch (error) {
                console.error(`Error loading projects for user ${user.id}:`, error);
                user.assignedProjects = [];
                return user;
              }
            })
          );
          
          renderUserList(usersWithProjects);
        } else {
          showMessage('KullanÄ±cÄ±lar yÃ¼klenirken hata oluÅŸtu', 'error');
        }
      } catch (error) {
        console.error('Error loading users:', error);
        showMessage('KullanÄ±cÄ±lar yÃ¼klenirken hata oluÅŸtu', 'error');
      }
    }

    function renderUserList(users) {
      const userTableBody = document.getElementById('userTableBody');
      if (!userTableBody) return;

      userTableBody.innerHTML = users.map(user => `
        <tr>
          <td>${user.id}</td>
          <td>${user.phone}</td>
          <td>${user.role || 'user'}</td>
          <td>
            <span style="color: ${user.is_active ? '#28a745' : '#dc3545'};">
              ${user.is_active ? 'Aktif' : 'Pasif'}
            </span>
          </td>
          <td>
            ${user.assignedProjects && user.assignedProjects.length > 0 
              ? user.assignedProjects.map(p => `<span style="
                  display: inline-block; background: rgba(0,123,255,0.2); 
                  color: #007bff; padding: 2px 6px; border-radius: 10px; 
                  font-size: 11px; margin: 1px;
                ">${p.project_name || p.project_code || `Proje ${p.id}`}</span>`).join(' ')
              : '<span style="color: #6c757d;">AtanmamÄ±ÅŸ</span>'
            }
          </td>
          <td>
            <button class="edit-user-btn" data-user-id="${user.id}" 
                    style="padding: 3px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">
              DÃ¼zenle
            </button>
            <button class="delete-user-btn" data-user-id="${user.id}"
                    style="padding: 3px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
              Sil
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function editUser(userId) {
      // Load user data, projects, and user's current project assignments
      try {
        const [userResponse, projResponse, userProjectsResponse] = await Promise.all([
          fetch('/admin/users', { credentials: 'include' }),
          fetch('/admin/projects', { credentials: 'include' }),
          fetch(`/admin/users/${userId}/projects`, { credentials: 'include' })
        ]);
        
        if (!userResponse.ok) return;
        
        const userData = await userResponse.json();
        const user = userData.data.find(u => u.id == userId);
        if (!user) return;
        
        let projects = [];
        if (projResponse.ok) {
          const projData = await projResponse.json();
          projects = projData.data || [];
        }

        let userProjects = [];
        if (userProjectsResponse.ok) {
          const userProjData = await userProjectsResponse.json();
          userProjects = userProjData.data || [];
        }

        const assignedProjectIds = userProjects.map(p => p.id);
        
        const projectCheckboxes = projects.map(proj => 
          `<div style="display: flex; align-items: center; margin-bottom: 10px;">
            <input type="checkbox" 
                   name="project_ids" 
                   value="${proj.id}" 
                   id="project_${proj.id}"
                   ${assignedProjectIds.includes(proj.id) ? 'checked' : ''}
                   style="margin-right: 10px; transform: scale(1.2);">
            <label for="project_${proj.id}" style="color: white; cursor: pointer;">
              ${proj.project_name || proj.name || `Proje ${proj.id}`}
            </label>
          </div>`
        ).join('');

        // Create modern edit modal
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
          z-index: 1000; backdrop-filter: blur(2px);
        `;
        
        modal.innerHTML = `
          <div style="
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 50%, #a855f7 100%); 
            padding: 30px; border-radius: 15px; width: 500px; max-width: 95%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
              <h3 style="color: white; margin: 0; font-size: 24px; font-weight: 600;">âœï¸ KullanÄ±cÄ± DÃ¼zenle</h3>
              <button type="button" class="modal-close-btn" style="
                background: rgba(255,255,255,0.1); border: none; color: white; 
                width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
                font-size: 18px; display: flex; align-items: center; justify-content: center;
              ">Ã—</button>
            </div>
            
            <form id="editUserForm">
              <div style="margin-bottom: 20px;">
                <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">ğŸ“± Telefon NumarasÄ±:</label>
                <input type="text" name="phone" value="${user.phone}" required style="
                  width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                  background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
                ">
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">ğŸ‘¨â€ğŸ’¼ KullanÄ±cÄ± AdÄ±:</label>
                <input type="text" name="name" value="${user.name || ''}" style="
                  width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                  background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
                ">
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">ğŸ” Yeni Åifre:</label>
                <input type="password" name="password" placeholder="DeÄŸiÅŸtirmek istemiyorsanÄ±z boÅŸ bÄ±rakÄ±n" style="
                  width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                  background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
                ">
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="color: white; display: block; margin-bottom: 12px; font-weight: 500;">ğŸ—ï¸ Atanan Projeler:</label>
                <div style="
                  max-height: 200px; overflow-y: auto; 
                  background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;
                  border: 1px solid rgba(255,255,255,0.3);
                ">
                  ${projectCheckboxes}
                </div>
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">âš¡ Rol:</label>
                <select name="role" style="
                  width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                  background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
                ">
                  <option value="user" ${user.role === 'user' ? 'selected' : ''}>ğŸ‘¤ KullanÄ±cÄ±</option>
                  <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ğŸ‘‘ Admin</option>
                </select>
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">ğŸ”„ Durum:</label>
                <select name="is_active" style="
                  width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
                  background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box;
                ">
                  <option value="true" ${user.is_active ? 'selected' : ''}>âœ… Aktif</option>
                  <option value="false" ${!user.is_active ? 'selected' : ''}>âŒ Pasif</option>
                </select>
              </div>
              
              <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                <button type="button" class="modal-cancel-btn" style="
                  padding: 12px 24px; background: rgba(255,255,255,0.1); color: white; 
                  border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer;
                  font-size: 16px; transition: all 0.3s ease;
                ">âŒ Ä°ptal</button>
                <button type="submit" style="
                  padding: 12px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                  color: white; border: none; border-radius: 8px; cursor: pointer;
                  font-size: 16px; font-weight: 600; transition: all 0.3s ease;
                  box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
                ">ğŸ’¾ GÃ¼ncelle</button>
              </div>
            </form>
          </div>
        `;
        
        modal.className = 'modal';
        document.body.appendChild(modal);
        
        // Handle close buttons
        modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.remove());
        modal.querySelector('.modal-cancel-btn').addEventListener('click', () => modal.remove());
        
        // Close on backdrop click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
        
        // Handle form submission with all fields
        modal.querySelector('#editUserForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = 'â³ GÃ¼ncelleniyor...';
          submitBtn.disabled = true;
          
          try {
            // Get selected project IDs from checkboxes
            const selectedProjectIds = Array.from(
              e.target.querySelectorAll('input[name="project_ids"]:checked')
            ).map(checkbox => parseInt(checkbox.value));
            
            const updateData = {
              phone: formData.get('phone'),
              name: formData.get('name'),
              // Keep old project_id field for backward compatibility (will be ignored)
              project_id: null, 
              role: formData.get('role'),
              is_active: formData.get('is_active') === 'true'
            };
            
            // Only include password if provided
            if (formData.get('password') && formData.get('password').trim()) {
              updateData.password = formData.get('password');
            }

            // Update user info
            const userResponse = await fetch(`/admin/users/${userId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(updateData)
            });
            
            if (!userResponse.ok) {
              const errorData = await userResponse.json();
              showMessage('âŒ ' + (errorData.error || 'KullanÄ±cÄ± gÃ¼ncellenirken hata oluÅŸtu'), 'error');
              return;
            }

            // Update project assignments
            const projectResponse = await fetch(`/admin/users/${userId}/projects`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ project_ids: selectedProjectIds })
            });
            
            if (projectResponse.ok) {
              showMessage('âœ… KullanÄ±cÄ± ve proje atamalarÄ± baÅŸarÄ±yla gÃ¼ncellendi', 'success');
              modal.remove();
              loadUsers();
            } else {
              const errorData = await projectResponse.json();
              showMessage('âš ï¸ KullanÄ±cÄ± gÃ¼ncellendi ancak proje atamalarÄ± gÃ¼ncellenirken hata oluÅŸtu: ' + (errorData.error || 'Bilinmeyen hata'), 'warning');
              modal.remove();
              loadUsers();
            }
          } catch (error) {
            console.error('User update error:', error);
            showMessage('âŒ BaÄŸlantÄ± hatasÄ±: ' + error.message, 'error');
          } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

      } catch (error) {
        console.error('Error fetching user data:', error);
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Bu kullanÄ±cÄ±yÄ± silmek istediÄŸinizden emin misiniz?')) {
        return;
      }

      try {
        const response = await fetch(`/admin/users/${userId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (response.ok) {
          showMessage('KullanÄ±cÄ± baÅŸarÄ±yla silindi', 'success');
          loadUsers();
        } else {
          showMessage('KullanÄ±cÄ± silinirken hata oluÅŸtu', 'error');
        }
      } catch (error) {
        showMessage('KullanÄ±cÄ± silinirken hata oluÅŸtu', 'error');
      }
    }

    // Event listeners setup
    function setupEventListeners() {
      // Navigation buttons
      document.getElementById('projectsBtn').addEventListener('click', () => {
        window.location.href = '/projects';
      });

      document.getElementById('logoutBtn').addEventListener('click', logout);

      // Tab navigation
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.dataset.tab;
          switchTab(tabName);
        });
      });

      // Upload button
      document.getElementById('uploadBtn').addEventListener('click', uploadFiles);

      // Add user button
      document.getElementById('addUserBtn').addEventListener('click', showAddUserForm);

      // Delegate events for dynamically created buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('download-btn')) {
          const url = e.target.dataset.url;
          downloadFile(url);
        }
        
        if (e.target.classList.contains('delete-btn')) {
          const project = e.target.dataset.project;
          const category = e.target.dataset.category;
          const filename = e.target.dataset.filename;
          deleteFile(project, category, filename);
        }

        if (e.target.classList.contains('project-item') || e.target.closest('.project-item')) {
          const projectItem = e.target.classList.contains('project-item') ? e.target : e.target.closest('.project-item');
          const projectId = projectItem.dataset.projectId;
          if (projectId) {
            selectProject(parseInt(projectId));
          }
        }

        if (e.target.classList.contains('edit-user-btn')) {
          const userId = e.target.dataset.userId;
          editUser(userId);
        }

        if (e.target.classList.contains('delete-user-btn')) {
          const userId = e.target.dataset.userId;
          deleteUser(userId);
        }
      });
    }

    // Update DOMContentLoaded to include event listeners
    document.addEventListener('DOMContentLoaded', function() {
      loadAdminInfo();
      loadProjects();
      loadUsers();
      loadStats();
      setupFileUpload();
      setupEventListeners();
    });
  </script>
</body>
</html>