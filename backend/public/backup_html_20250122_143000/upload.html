<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dosya Y√ºkleme</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }
    .nav-links {
      display: flex;
      gap: 15px;
    }
    .nav-links a, .nav-links button {
      color: #fff;
      text-decoration: none;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      transition: background-color 0.3s;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .nav-links a:hover, .nav-links button:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .logout-btn {
      background: #ef4444 !important;
    }
    .upload-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 25px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }
    select, input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }
    select option {
      background: #1a1a2e;
      color: #fff;
    }
    input[type="file"] {
      padding: 8px;
    }
    .file-drop-zone {
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
    }
    .file-drop-zone:hover {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.1);
    }
    .file-drop-zone.dragover {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.2);
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
      display: none;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      width: 0%;
      transition: width 0.3s ease;
    }
    .message {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 600;
      display: none;
    }
    .success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
      color: #22c55e;
    }
    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    .file-list {
      margin-top: 20px;
    }
    .file-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üìÅ Dosya Y√ºkleme</h1>
        <p id="adminInfo">Y√ºkleniyor...</p>
      </div>
      <div class="nav-links">
  <a href="/projects">üèóÔ∏è Projeler</a>
  <a href="/files">üóÇÔ∏è Dosya Y√∂neticisi</a>
        <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
      </div>
    </div>

    <div class="message" id="message"></div>

    <div class="grid">
      <!-- Proje Se√ßimi ve Genel Dosyalar -->
      <div class="upload-section">
        <h2>üìã Proje Se√ßimi</h2>
        <div class="form-group">
          <label for="projectSelect">Proje Se√ßin *</label>
          <select id="projectSelect" required>
            <option value="">Proje y√ºkleniyor...</option>
          </select>
        </div>
        
        <h3>üìÑ Genel Dosyalar</h3>
        <form id="generalUploadForm" enctype="multipart/form-data">
          <div class="form-group">
            <label for="fileType">Dosya T√ºr√º</label>
            <select id="fileType" name="fileType">
              <option value="files">Genel Dosyalar</option>
              <option value="other">Diƒüer Belgeler</option>
            </select>
          </div>
          <div class="form-group">
            <label>Dosya Se√ßin</label>
            <div class="file-drop-zone" onclick="document.getElementById('generalFiles').click()">
              <p>üìé Dosyalarƒ± buraya s√ºr√ºkleyin veya tƒ±klayƒ±n</p>
              <p style="font-size: 14px; opacity: 0.7;">PDF, DOC, DOCX, XLS, XLSX, ZIP, RAR</p>
            </div>
            <input type="file" id="generalFiles" name="files" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.zip,.rar" style="display: none;">
          </div>
          <div id="generalFileList" class="file-list"></div>
          <div class="progress-bar" id="generalProgress">
            <div class="progress-fill" id="generalProgressFill"></div>
          </div>
          <button type="submit" id="generalUploadBtn">Dosyalarƒ± Y√ºkle</button>
        </form>
      </div>

      <!-- ƒ∞maj Y√ºklemeleri -->
      <div class="upload-section">
        <h2>üñºÔ∏è ƒ∞maj Y√ºklemeleri</h2>
        <form id="imageUploadForm" enctype="multipart/form-data">
          <div class="form-group">
            <label for="imageType">ƒ∞maj T√ºr√º</label>
            <select id="imageType" name="imageType">
              <option value="drone_photos">Drone Fotoƒüraflarƒ±</option>
              <option value="floor_plans">Kat Planlarƒ±</option>
              <option value="orthophoto">Ortofoto</option>
              <option value="view_360">360¬∞ G√∂r√ºn√ºm</option>
            </select>
          </div>
          <div class="form-group">
            <label>ƒ∞maj Dosyalarƒ± Se√ßin</label>
            <div class="file-drop-zone" onclick="document.getElementById('imageFiles').click()">
              <p>üñºÔ∏è ƒ∞majlarƒ± buraya s√ºr√ºkleyin veya tƒ±klayƒ±n</p>
              <p style="font-size: 14px; opacity: 0.7;">JPG, JPEG, PNG, TIFF</p>
            </div>
            <input type="file" id="imageFiles" name="files" multiple accept=".jpg,.jpeg,.png,.tiff,.tif" style="display: none;">
          </div>
          <div id="imageFileList" class="file-list"></div>
          <div class="progress-bar" id="imageProgress">
            <div class="progress-fill" id="imageProgressFill"></div>
          </div>
          <button type="submit" id="imageUploadBtn">ƒ∞majlarƒ± Y√ºkle</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    let selectedProject = null;
    let projects = [];

    // Sayfa y√ºklendiƒüinde admin bilgilerini ve projeleri getir
    async function loadAdminInfo() {
      try {
        const response = await fetch('/session', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          if (data.admin) {
            document.getElementById('adminInfo').textContent = 
              `Admin: ${data.admin.phone} (${data.admin.role})`;
          }
        }
      } catch (error) {
        console.error('Admin bilgileri y√ºklenemedi:', error);
      }
    }

    async function loadProjects() {
      try {
        const response = await fetch('/api/projects', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          projects = data.data;
          updateProjectSelect();
        } else {
          showMessage('Projeler y√ºklenemedi', 'error');
        }
      } catch (error) {
        showMessage('Projeler y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
      }
    }

    function updateProjectSelect() {
      const select = document.getElementById('projectSelect');
      select.innerHTML = '<option value="">Proje se√ßin...</option>';
      
      projects.forEach(project => {
        if (project.is_active) {
          const option = document.createElement('option');
          option.value = project.project_code;
          option.textContent = `${project.project_code} - ${project.name}`;
          select.appendChild(option);
        }
      });
    }

    function logout() {
      fetch('/logout', { method: 'POST', credentials: 'include' })
        .then(() => window.location.href = '/admin/login')
        .catch(() => alert('√áƒ±kƒ±≈ü yaparken hata olu≈ütu'));
    }

    function showMessage(text, type) {
      const message = document.getElementById('message');
      message.textContent = text;
      message.className = 'message ' + type;
      message.style.display = 'block';
      setTimeout(() => message.style.display = 'none', 5000);
    }

    // Proje se√ßimi deƒüi≈ütiƒüinde
    document.getElementById('projectSelect').addEventListener('change', function() {
      selectedProject = this.value;
    });

    // Drag & Drop fonksiyonlarƒ±
    function setupDragDrop(dropZone, fileInput) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
      });

      dropZone.addEventListener('drop', function(e) {
        const files = e.dataTransfer.files;
        fileInput.files = files;
        updateFileList(files, dropZone.closest('.upload-section'));
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
    }

    // Dosya listesini g√ºncelle
    function updateFileList(files, section) {
      const fileList = section.querySelector('.file-list');
      fileList.innerHTML = '';
      
      Array.from(files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <span>üìÑ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
          <span>${file.type}</span>
        `;
        fileList.appendChild(fileItem);
      });
    }

    // Form g√∂nderme fonksiyonu
    async function uploadFiles(form, progressBar, progressFill, button) {
      if (!selectedProject) {
        showMessage('L√ºtfen √∂nce bir proje se√ßin', 'error');
        return;
      }

      const formData = new FormData(form);
      formData.append('project', selectedProject);

      button.disabled = true;
      button.textContent = 'Y√ºkleniyor...';
      progressBar.style.display = 'block';

      try {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressFill.style.width = percentComplete + '%';
          }
        });

        xhr.onreadystatechange = function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            button.disabled = false;
            button.textContent = button.id.includes('general') ? 'Dosyalarƒ± Y√ºkle' : 'ƒ∞majlarƒ± Y√ºkle';
            progressBar.style.display = 'none';
            progressFill.style.width = '0%';

            if (xhr.status === 200) {
              const result = JSON.parse(xhr.responseText);
              showMessage('Dosyalar ba≈üarƒ±yla y√ºklendi!', 'success');
              form.reset();
              form.querySelector('.file-list').innerHTML = '';
            } else {
              const error = JSON.parse(xhr.responseText);
              showMessage('Y√ºkleme hatasƒ±: ' + (error.error || 'Bilinmeyen hata'), 'error');
            }
          }
        };

        xhr.open('POST', '/upload');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);

      } catch (error) {
        button.disabled = false;
        button.textContent = button.id.includes('general') ? 'Dosyalarƒ± Y√ºkle' : 'ƒ∞majlarƒ± Y√ºkle';
        progressBar.style.display = 'none';
        showMessage('Y√ºkleme hatasƒ±: ' + error.message, 'error');
      }
    }

    // Event listener'lar
    document.addEventListener('DOMContentLoaded', function() {
      // Drag & Drop kurulumu
      const generalDropZone = document.querySelector('#generalUploadForm .file-drop-zone');
      const imageDropZone = document.querySelector('#imageUploadForm .file-drop-zone');
      
      setupDragDrop(generalDropZone, document.getElementById('generalFiles'));
      setupDragDrop(imageDropZone, document.getElementById('imageFiles'));

      // Dosya se√ßimi deƒüi≈ütiƒüinde listeleri g√ºncelle
      document.getElementById('generalFiles').addEventListener('change', function() {
        updateFileList(this.files, this.closest('.upload-section'));
      });

      document.getElementById('imageFiles').addEventListener('change', function() {
        updateFileList(this.files, this.closest('.upload-section'));
      });

      // Form g√∂nderme
      document.getElementById('generalUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const progressBar = document.getElementById('generalProgress');
        const progressFill = document.getElementById('generalProgressFill');
        const button = document.getElementById('generalUploadBtn');
        uploadFiles(this, progressBar, progressFill, button);
      });

      document.getElementById('imageUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const progressBar = document.getElementById('imageProgress');
        const progressFill = document.getElementById('imageProgressFill');
        const button = document.getElementById('imageUploadBtn');
        uploadFiles(this, progressBar, progressFill, button);
      });

      // Sayfa y√ºklendiƒüinde verileri getir
      loadAdminInfo();
      loadProjects();
    });
  </script>
</body>
</html>